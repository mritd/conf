# ============================================================================
# Zsh é…ç½®æ–‡ä»¶
# Author: mritd <mritd@linux.com>
# ============================================================================

# ============================================================================
# Prezto
# ============================================================================

if [[ -s "${ZDOTDIR:-$HOME}/.zprezto/init.zsh" ]]; then
    source "${ZDOTDIR:-$HOME}/.zprezto/init.zsh"
fi

# ============================================================================
# åŸºç¡€è®¾ç½®
# ============================================================================

# é»˜è®¤æƒé™æ©ç 
umask 0022

# ç¼–è¾‘å™¨
export EDITOR='vim'
export VISUAL='vim'

# Grep é¢œè‰²
export GREP_COLOR='01;31'
export GREP_COLORS='mt=01;31'

# å†å²æœç´¢
export HISTORY_SUBSTRING_SEARCH_PREFIXED=true
export HISTORY_SUBSTRING_SEARCH_ENSURE_UNIQUE=true

# å…è®¸æ–‡ä»¶è¦†ç›–
unsetopt noclobber

# ============================================================================
# macOS é…ç½®
# ============================================================================

if [[ "$OSTYPE" =~ ^darwin ]]; then
    # Homebrew
    export HOMEBREW_PREFIX="/opt/homebrew"
    export HOMEBREW_CELLAR="/opt/homebrew/Cellar"
    export HOMEBREW_REPOSITORY="/opt/homebrew"
    export HOMEBREW_NO_ENV_HINTS=1
    export HOMEBREW_BUNDLE_DUMP_NO_GO=1
    export HOMEBREW_BUNDLE_DUMP_NO_VSCODE=1

    # Homebrew PATH
    export PATH="/opt/homebrew/bin:/opt/homebrew/sbin:${PATH}"
    export MANPATH="/opt/homebrew/share/man${MANPATH+:$MANPATH}:"
    export INFOPATH="/opt/homebrew/share/info:${INFOPATH:-}"
    export FPATH="${HOMEBREW_PREFIX}/share/zsh/site-functions:${FPATH}"

    # GNU å·¥å…· (brew install coreutils findutils gnu-tar gnu-sed gawk gnu-indent gnu-getopt grep)
    for tool in coreutils findutils gnu-tar gnu-sed gnu-indent grep; do
        [[ -d "${HOMEBREW_PREFIX}/opt/${tool}/libexec/gnubin" ]] && \
            export PATH="${HOMEBREW_PREFIX}/opt/${tool}/libexec/gnubin:${PATH}"
    done
    [[ -d "${HOMEBREW_PREFIX}/opt/gnu-getopt/bin" ]] && \
        export PATH="${HOMEBREW_PREFIX}/opt/gnu-getopt/bin:${PATH}"

    # OpenSSL
    if [[ -d "${HOMEBREW_PREFIX}/opt/openssl@3" ]]; then
        export PATH="${HOMEBREW_PREFIX}/opt/openssl@3/bin:${PATH}"
        export LDFLAGS="-L${HOMEBREW_PREFIX}/opt/openssl@3/lib"
        export CPPFLAGS="-I${HOMEBREW_PREFIX}/opt/openssl@3/include"
        export PKG_CONFIG_PATH="${HOMEBREW_PREFIX}/opt/openssl@3/lib/pkgconfig"
    fi

    # curl
    [[ -d "${HOMEBREW_PREFIX}/opt/curl/bin" ]] && \
        export PATH="${HOMEBREW_PREFIX}/opt/curl/bin:${PATH}"

    # MySQL client
    [[ -d "${HOMEBREW_PREFIX}/opt/mysql-client/bin" ]] && \
        export PATH="${HOMEBREW_PREFIX}/opt/mysql-client/bin:${PATH}"
fi

# ============================================================================
# Linux é…ç½®
# ============================================================================

if [[ "$OSTYPE" =~ ^linux ]]; then
    export LANGUAGE='en_US.UTF-8'
    export LC_ALL='en_US.UTF-8'
    export LC_CTYPE='UTF-8'
    export LANG='en_US.UTF-8'
fi

# ============================================================================
# å¼€å‘å·¥å…· PATH
# ============================================================================

# DevTools (/opt/devtools)
export DEV_TOOLS="/opt/devtools"
if [[ -d "${DEV_TOOLS}" ]]; then
    export PATH="${DEV_TOOLS}/bin:${DEV_TOOLS}/sbin:${PATH}"
    for dir in "${DEV_TOOLS}"/*(/N); do
        [[ ! -f "${dir}/.skip" ]] && export PATH="${dir}/bin:${dir}/sbin:${PATH}"
    done
fi

# ç”¨æˆ·æœ¬åœ° bin
export PATH="${HOME}/.local/bin:${PATH}"

# Go
export GOPATH="${HOME}/gopath"
export PATH="${GOPATH}/bin:${PATH}"

# Rust
export PATH="${HOME}/.cargo/bin:${PATH}"

# Solana
[[ -d "${HOME}/.local/share/solana/install/active_release/bin" ]] && \
    export PATH="${HOME}/.local/share/solana/install/active_release/bin:${PATH}"

# Krew (kubectl plugin manager)
export PATH="${KREW_ROOT:-${HOME}/.krew}/bin:${PATH}"

# è‡ªå®šä¹‰ zsh å‡½æ•°
export FPATH="${HOME}/.zsh_funcs:${FPATH}"

# ============================================================================
# Prezto è¦†ç›–è®¾ç½®
# ============================================================================

# æ¢å¤è¢« prezto/utility æ¨¡å— noglob çš„å‘½ä»¤
# https://github.com/sorin-ionescu/prezto/tree/master/modules/utility#disabled-file-globbing
for cmd in bower fc find ftp history locate rake rsync scp sftp; do
    (( $+aliases[$cmd] )) && unalias $cmd
done

# ============================================================================
# åˆ«å
# ============================================================================

# ls
alias l='ls -alh'
alias lm='ls -alh | "$PAGER"'

# delta (git diff viewer)
alias dff='delta'

# Docker
alias dc='docker compose'

# å¸¸è§æ‹¼å†™é”™è¯¯
alias kuebctl='kubectl'

# é˜»æ­¢æ„å¤–ä½¿ç”¨ mg editor
alias mg='echo -e "\033[31mFFFFFFFFucking mg editor...\033[0m"'

# ============================================================================
# å·¥å…·é›†æˆ
# ============================================================================

# mise (è¿è¡Œæ—¶ç‰ˆæœ¬ç®¡ç†)
if (( $+commands[mise] )); then
    eval "$(mise activate zsh)"
fi

# bat (cat æ›¿ä»£)
if (( $+commands[bat] )); then
    alias cat='bat --theme OneHalfDark --style=plain --paging=never'
elif (( $+commands[batcat] )); then
    alias cat='batcat --theme OneHalfDark --style=plain --paging=never'
fi

# ncdu (ç£ç›˜åˆ†æ)
if (( $+commands[ncdu] )); then
    if [[ "$OSTYPE" =~ ^linux ]]; then
        alias ncdu='ncdu --color dark --exclude-kernfs'
    else
        alias ncdu='ncdu --color dark'
    fi
fi

# xh (HTTPie æ›¿ä»£)
if (( $+commands[xh] )); then
    alias http='xh'
    alias https='xh --https'
fi

# ============================================================================
# è‡ªå®šä¹‰å‡½æ•°
# ============================================================================

# tmux å¿«é€Ÿè¿æ¥
function mux() {
    tmux new-session -A -s "ğŸ local"
}

# è½¬å°å†™
function lower() {
    echo "$@" | tr '[:upper:]' '[:lower:]'
}

# ============================================================================
# Completion
# ============================================================================

# ç”Ÿæˆ completion (ä»…åœ¨æ–‡ä»¶ä¸å­˜åœ¨æ—¶)
[[ -d "${HOME}/.zsh_funcs" ]] || mkdir -p "${HOME}/.zsh_funcs"
for cmd in docker nerdctl podman kubectl helm; do
    if (( $+commands[$cmd] )) && [[ ! -f "${HOME}/.zsh_funcs/_${cmd}" ]]; then
        ${cmd} completion zsh > "${HOME}/.zsh_funcs/_${cmd}" 2>/dev/null
    fi
done

# åˆå§‹åŒ– completion (å¸¦ç¼“å­˜)
autoload -Uz compinit
if [[ -n ${ZDOTDIR:-$HOME}/.zcompdump(#qN.mh+24) ]]; then
    compinit
else
    compinit -C
fi

# ============================================================================
# ç”¨æˆ·ç§å¯†é…ç½®
# ============================================================================

[[ -f "${HOME}/.user.secret" ]] && source "${HOME}/.user.secret"
